<div class="page">

    <!-- This area is visible when NOT in edit mode -->
    <div id="display-section" style="display: inline-block;">
        <h3>Call for help!</h3>
        <div id="display-phone-numbers">
            <!-- phone numbers go here! -->
        </div>
        <h3>Notify surgeon.</h3>
        <button id="edit-button">Edit Phone Numbers</button>
    </div>

    <!-- This area is visible when in edit mode -->
    <form id="edit-section" style="display: none;">
        <h3>Edit Phone Numbers</h3>
        <div class="section">
            <p>There are five default phone numbers. Each are listed when you provide a <i>Phone Number</i> and then <i>Save</i>.</p>
            <p>You can start a phone call if <i>Create hyperlink?</i> is checked. For best results, provide a phone number in the format <i>555-555-5555</i>.</p>
            <p>If your phone number is not reachable by your device then you can prevent hyperlinks from showing up in events by unchecking <i>Create hyperlink?</i></p>
        </div>
        <div id="edit-phone-numbers"></div>
        <div class="section">
            <strong>Add a Phone Number</strong>
            <input type="text" class="fill-available" placeholder="Description" data-role="description" style="display: inline;">
            <input type="text" class="fill-available" placeholder="Phone Number" data-role="number" class="fill-available">
            <div>
                <input type="checkbox" data-role="isHyperlink" style="align-self: center;">
                <label>Create hyperlink?</label>
            </div>
        </div>
            
        <div>
            <button id="save" type="submit">Save</button>
            <button id="cancel" type="button">Cancel</button>
        </div>
    </form>

</div>

<script>

// This code is a bit tricky because it uses plain javascript in lieu of a templating engine.

// The data structure that is persisted in local storage is an associative array (i.e., "dictionary")
// keyed on `description`:
// {
//   "Fire": {
//     "description": "Fire",
//     "number": "Yell Loudly",
//     "isHyperlink": false
//   },
//   "My Custom Number": {
//     "description": "My Custom Number",
//     "number": "555-555-5555",
//     "isHyperlink": true
//   }
// }

(() => {
    "use strict";

    // This function determines whether the screen is in edit mode.
    const setEditMode = (isEditMode) => {
        const editSection = document.getElementById("edit-section");
        editSection.style.display =  isEditMode ? "block" : "none";
        document.getElementById("display-section").style.display = isEditMode ? "none" : "block";
        const editPhoneNumbers = document.getElementById("edit-phone-numbers");
        const phoneNumbers = getPhoneNumbers() || {};
        if (isEditMode) {
            editSection.reset();
            // Remove existing elements. Otherwise they are duplicated when flipping in and out of display mode.
            removeChildren(editPhoneNumbers);
            // Always show system phone numbers.
            const systemDescriptions = {"Code Team": "Code Team", "PICU": "PICU", "Fire": "Fire", "Overhead STAT": "Overhead STAT", "ECMO": "ECMO"};
            Object.keys(systemDescriptions).forEach(description => {
                let data = phoneNumbers[description] || {description, isHyperlink: true, number: "", isSystem: true};
                let element = createEditModePhoneNumberElement(data);
                editPhoneNumbers.appendChild(element);
            });
            // Now do the same for non-system phone numbers.
            Object.keys(phoneNumbers).forEach((description) => {
                // Skip system phone numbers.
                if (!systemDescriptions[description]) {
                    let data = phoneNumbers[description];
                    let element = createEditModePhoneNumberElement(data);
                    editPhoneNumbers.appendChild(element);
                }
            });
        } else {
            const keys = Object.keys(phoneNumbers);
            const displayPhoneNumbers = document.getElementById("display-phone-numbers");
            removeChildren(displayPhoneNumbers);
            if (keys.length === 0) {
                // Display Mode and no phone numbers are assigned
                displayPhoneNumbers.textContent = "You have not yet added phone numbers. Click the 'Edit Phone Numbers' button to customize this screen!";
            } else {
                keys.forEach((description) => {
                    let data = phoneNumbers[description];
                    let element = createDisplayModePhoneNumberElement(data);
                    displayPhoneNumbers.appendChild(element);
                });
            }
        }
    };

    /***
     * Removes the content of all children.
     */
    const removeChildren = node => {
        if (node.textContent) {
            node.textContent = "";
        }
        if (node.children) {
            while (node.children.length > 0) {
                node.children[0].remove();
            }
        }
    };

    /***
     * Creates all the elements needed to display a phone number.
     */
    const createDisplayModePhoneNumberElement = data => {
        const container = document.createElement("div");
        container.classList = "section";
        
        const description = document.createElement("strong");
        description.textContent = data.description;
        description.style.display = "block";
        container.appendChild(description);

        if (data.isHyperlink) {
            const link = document.createElement("a");
            link.href="tel:" + data.number;
            link.textContent = data.number;
            container.appendChild(link);
        } else {
            const number = document.createElement("div");
            number.textContent = data.number;
            container.appendChild(number);
        }
        return container;
    };

    
    /***
     * Creates all the elements needed to edit a phone number.
     * Note that logic is a little different if the (phone) number is a "system" number 
     * (e.g. "Code Team".)
     * @param data should be in the format of {number, description, isHyperlink, isSystem}.
     * Note: The element `dataset` is used a lot for identifying components in the save logic.
     */
    const createEditModePhoneNumberElement = (data) => {
        // Probably should have used a templating engine...
        const container = document.createElement("div");
        container.classList = "section";
        
        let description;
        if (data.isSystem) {
            description = document.createElement("strong");
            description.textContent = data.description; 
        } else {
            description = document.createElement("input");
            description.style.display = "inline";
            description.classList = "fill-available";
            description.value = data.description;
            description.placeholder = data.description || "Description";
        }
        description.dataset.description = data.description;
        description.dataset.role = "description";
        container.appendChild(description);

        const number = document.createElement("input");
        number.type = "text";
        number.value = data.number;
        number.placeholder = "Phone Number"
        number.dataset.role = "number";
        number.classList = "fill-available";
        container.appendChild(number);

        const checkboxWrapper = document.createElement("div");
        const isHyperlink = document.createElement("input");
        isHyperlink.type = "checkbox"
        isHyperlink.style.alignSelf = "center";
        // Override webkit user agent stylesheet default `margin-left` of "4px"
        isHyperlink.style.marginLeft = "0px";
        isHyperlink.checked = data.isHyperlink;
        isHyperlink.dataset.role = "isHyperlink";
        checkboxWrapper.appendChild(isHyperlink);

        const label = document.createElement("label");
        label.textContent = "Create hyperlink?";

        checkboxWrapper.appendChild(label);

        if (!data.isSystem) {
            const deleteButton = document.createElement("button");
            deleteButton.textContent = "Delete";
            deleteButton.style.float = "right";
            deleteButton.addEventListener("click", event => {
                container.remove();
            });
            checkboxWrapper.appendChild(deleteButton);
        }

        container.appendChild(checkboxWrapper);

        return container;
    };

    /***
     * Simple helper for retrieving phone numbers.
     */
    const getPhoneNumbers = () => {
        const stringData = localStorage.getItem("phone-numbers");
        return stringData ? JSON.parse(stringData) : {};
    }

    /***
     * Simple helper for saving phone numbers.
     */
    const setPhoneNumbers = (phoneNumbers) => {
        if (phoneNumbers.length) {
            console.warn("Oops - phoneNumbers should be an associative array.");
        }
        localStorage.setItem("phone-numbers", JSON.stringify(phoneNumbers));
    }

    /***
     * For each HTML element assigned the class "section", extract elements related to phone numbers.
     * This is a little tricky because the system phone numbers are handled differently compared to
     * the purely custom phone numbers.
     * @param event if this event is triggered by `form.submit` then use `preventDefault` to prevent an HTTP request.
     */
    const savePhoneNumbers = (event) => {
        // Don't allow the form to send an actual POST to a non-existent server.
        if (event && event.preventDefault) event.preventDefault();

        const phoneNumbers = {};
        const sections = document.getElementsByClassName("section");                
        // The following loop basically unwinds the HTML elements into associative array structure
        // that is persisted in localStorage. By using an associative array, we effectively 
        // avoid duplicates(i.e., where the description is duplicated) with "last-in-wins" rules.
        for (let i = 0; i < sections.length; i++) {
            
            // The checkbox is a child of a div. So, to keep this simple and future-proof,
            // just flatten all child nodes into one array.
            const flattenChildren = (node, result) => {
                for (let i = 0; i < node.children.length; i++) {
                    let child = node.children.item(i);
                    result.push(child);
                    flattenChildren(child, result);
                }
            };
            const children = [];
            flattenChildren(sections[i], children);

            // Reconstruct the old data. 
            let data = {description: null, number: null, isHyperlink: null};
            for (let j = 0; j < children.length; j++) {
                let child = children[j];
                if (child.dataset) {
                    const dataset = child.dataset;
                    if(dataset.role === "description") {
                        data.description = child.nodeName === "STRONG" ? dataset.description : child.value;
                    } else if (dataset.role === "number") {
                        data.number = child.value;
                    } else if (dataset.role === "isHyperlink") {
                        data.isHyperlink = child.checked;
                    }
                }
            }

            // Trim all string fields.
            Object.keys(data).forEach(keyName => {
                if (typeof(data[keyName]) === "string") {
                    data[keyName] = data[keyName].trim();
                }
            })

            // If there's valid data, keep it.
            if (data.description && data.number) {
                phoneNumbers[data.description] = data;
            }
        }

        setPhoneNumbers(phoneNumbers);
        setEditMode(false);
    };
    
    document.getElementById("edit-button").addEventListener("click", (element, event) => {
        setEditMode(true);
    });
    
    document.getElementById("cancel").addEventListener("click", (event) => {
        // Don't allow the form to send an actual POST to a non-existent server.
        if (event.preventDefault) event.preventDefault();
        setEditMode(false);
        return false;
    });

    document.getElementById("edit-section").addEventListener("submit", savePhoneNumbers);
    document.getElementById("save").addEventListener("click", savePhoneNumbers);

    setEditMode(false);

})();

</script>
